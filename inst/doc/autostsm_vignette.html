<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Automatic Structural Time Series Model</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Automatic Structural Time Series Model</h1>



<p><code>autostm</code> (Automatic Structural Time Series Model) is
designed to automatically detect the appropriate decomposition for a
univariate time series into trend, seasonal, and cycle components using
a state space approach. The package also has the functionality perform
structural interpolation: i.e. interpolated a quarterly series into a
monthly series using either end of period, period average, or period sum
methods. The unobserved components are estimated with the Kalman filter
and all model parameters are estimated using maximum likelihood. The
Kalman filter and smoother are implemented in <code>Rcpp</code> so it is
reasonably fast. This package is designed to handle time series of any
frequency (standard or not), series with multiple seasonalities,
seasonalities with fractional periodicities, missing data imputation,
and irregularly spaced dates (i.e. daily data with missing data due to
weekends and holidays, etc.).</p>
<p>With ease-of-use in mind, all the user has to do is provide a two
column data frame: one column with dates and one column with the
univariate time series. Everything else is handled by the algorithm
including data frequency detection (observations per year), trend
specification, cycle specification, seasonal specification, missing data
imputation, anomaly detection, structural break detection, and whether
or not to log transform the data. The user can manually set the
preferred decomposition if desired, however. All components are assumed
to be stochastic, which allows for time-varying trend, cycle, and
seasonalities, unless the user specifies otherwise using the
<code>det_trend</code>, <code>det_drift</code>, <code>det_seas</code>,
<code>det_cycle</code>, and <code>det_obs</code> arguments in
<code>stsm_estimate</code>. The algorithm can handle secondly, minutely,
hourly, daily, monthly, and quarterly frequencies as well as daily data
that is weekday only. It is also capable of handling non-standard
frequencies (i.e. frequencies that are non of the above). To build an
interpolation model, all the user has to do is set
<code>interpolate</code> and <code>interpolate_method</code>. The user
only needs to call <code>stsm_estimate</code> to fit the model and
<code>stsm_forecast</code> to filter and forecast the data.
Additionally, the user can call <code>stsm_detect_anomalies</code> and
<code>stsm_detect_breaks</code> to perform anomaly and structural break
detection respectively.</p>
<div id="state-space-model" class="section level1">
<h1>State Space Model</h1>
<p>The model is based on the decomposition</p>
<p><span class="math display">\[
Y_t = T_t + C_t + S_t + B^o X^o_t + e_t
\]</span></p>
<p>where <span class="math inline">\(Y_t\)</span> is a univariate time
series, <span class="math inline">\(T_t\)</span> is the trend component,
<span class="math inline">\(C_t\)</span> is the cycle component, <span class="math inline">\(S_t\)</span> is the seasonal component, <span class="math inline">\(X^o_t\)</span> is optional exogenous data in the
observation equation, and <span class="math inline">\(e_t \sim N(0,
\sigma_e^2)\)</span> is the observation error. The seasonal and cycle
components are assumed to be of a trigonometric form, while the trend is
assumed to be one of three types: a random walk, a random walk with an
AR(1) drift, or a double random walk (random walk with a random walk
drift).</p>
<p>The state space model is written as <span class="math display">\[
Y_t = A + H \beta + B^o X^o_t + e_t, e_t \sim N(0, R)\\
\beta_t = D + F \beta_{t-1} + B^s X^s_t + u_t, u_t \sim N(0, Q)
\]</span></p>
<p>where the first equation is the observation equation and the second
equation is the transition equation. <span class="math inline">\(A\)</span> is the observation intercept, <span class="math inline">\(H\)</span> is the observation matrix, <span class="math inline">\(e_t \sim N(0, R)\)</span> is the observation
error, and <span class="math inline">\(R\)</span> is the observation
error-covariance matrix. <span class="math inline">\(\beta_t\)</span> is
the vector of the state components, <span class="math inline">\(D\)</span> is the state intercept matrix, <span class="math inline">\(F\)</span> is the transition matrix, <span class="math inline">\(X^s_t\)</span> is optional exogenous data in the
state equation, <span class="math inline">\(v_t \sim N(0,
Q_{s_t})\)</span> is the state error, and <span class="math inline">\(Q\)</span> is the state error-covariance
matrix.</p>
<div id="trend-models" class="section level2">
<h2>Trend Models</h2>
<p>If trend is “random-walk” the trend model is specified as the I(1)
process <span class="math display">\[
T_t = T_{t-1} + e_t, e_t \sim N(0, \sigma_t^2)
\]</span></p>
<p>If trend is “random-walk-drift”, the trend model is specified as the
I(1) process <span class="math display">\[
T_t = D_{t-1} + T_{t-1} + e_t, e_t \sim N(0, \sigma_t^2) \\
D_t = d + \phi_d D_{t-1} + n_t, n_t \sim N(0, \sigma_d^2)
\]</span> where <span class="math inline">\(D_t\)</span> is the
drift.</p>
<p>If trend is “double-random-walk”, the trend model is specified as the
I(2) process <span class="math display">\[
T_t = D_{t-1} + T_{t-1} + e_t, e_t \sim N(0, \sigma_t^2) \\
D_t = D_{t-1} + n_t, n_t \sim N(0, \sigma_d^2)
\]</span></p>
</div>
<div id="cycle-model" class="section level2">
<h2>Cycle Model</h2>
<p>The cycle is modeled using either the trigonometric process</p>
<p><span class="math display">\[
\begin{bmatrix}
c_t \\
c_t^{*}
\end{bmatrix} =
\phi_c \begin{bmatrix}
cos(\lambda) &amp; sin(\lambda) \\
-sin(\lambda) &amp; cos(\lambda)
\end{bmatrix}
\begin{bmatrix}
c_{t-1} \\
c_{t-1}^{*}
\end{bmatrix} +
\begin{bmatrix}
u_t \\
u_t^{*}
\end{bmatrix}, u_t, u_t^{*} \sim N(0, \sigma_c^2)
\]</span> where <span class="math inline">\(\lambda\)</span> is the
frequency of the cycle and <span class="math inline">\(\phi_c
\in{(0,1)}\)</span> to make the cycle stationary for forecasting
purposes, or the ARMA(2,1) process</p>
<p><span class="math display">\[
\begin{bmatrix}
c_t \\ c_{t-1} \\ \vdots \\ c_{t-p+2} \\ c_{t-p+1} \\ e_t \\ e_{t-1} \\
\vdots \\ e_{t-q+2} \\ e_{t-q+1}
\end{bmatrix} =
\begin{bmatrix}
\phi_{c,1} &amp; \phi_{c,2} &amp; \ldots &amp; \phi_{c,p-1} &amp;
\phi_{c,p} &amp; \theta_{c,1} &amp; \theta_{c,2} &amp; \ldots &amp;
\theta_{c,q-1} &amp; \theta_{c,q} \\
1 &amp; 0 &amp; \ldots &amp; 0 &amp; 0 &amp; \ldots &amp; \ldots &amp;
\ldots &amp; \ldots &amp; 0 \\
0 &amp; \ddots &amp;  &amp; \vdots &amp; \vdots &amp; \ddots
&amp;  &amp; \ddots &amp;  &amp;  \vdots \\
\vdots &amp;  &amp; \ddots &amp; \vdots &amp; \vdots &amp;  &amp;
\ddots&amp; &amp; \ddots &amp; \vdots \\
0 &amp; \ldots &amp; \dots &amp; 1 &amp; 0 &amp; \ldots &amp; \ldots
&amp; \ldots &amp; \dots &amp; 0 \\
0 &amp; \ldots &amp; \ldots &amp; \ldots &amp; 0 &amp; \ldots &amp;
\ldots &amp; \ldots &amp; \ldots &amp; 0 \\
\vdots &amp; \ddots &amp;  &amp;  &amp; \vdots &amp; 1 &amp; 0 &amp;
\ldots &amp; 0 &amp; \vdots \\
\vdots &amp;  &amp; \ddots &amp;  &amp; \vdots &amp; 0 &amp; \ddots
&amp;  &amp; \vdots &amp; \vdots \\
\vdots &amp;  &amp;  &amp; \ddots &amp; \vdots &amp; \vdots &amp;  &amp;
\ddots &amp; \vdots &amp; \vdots \\
0 &amp; \ldots &amp; \ldots &amp; \ldots &amp; 0 &amp; 0 &amp; \ldots
&amp; \ldots &amp; 1 &amp; 0\\
\end{bmatrix}
\begin{bmatrix}
c_{t-1} \\ c_{t-2} \\ \vdots \\ c_{t-p+1} \\ c_{t-p} \\ e_{t-1} \\
e_{t-2} \\ \vdots \\ e_{t-q+1} \\e_{t-q}
\end{bmatrix} +
\begin{bmatrix}
e_t \\ 0 \\ \vdots \\ \vdots \\ 0 \\ e_t \\ 0 \\ \vdots \\ \vdots \\0
\end{bmatrix},
e_t \sim N(0, \sigma_c^2)
\]</span> where <span class="math inline">\(p\)</span> is the
autoregressive lag length and <span class="math inline">\(q\)</span> is
the moving average lag length. The ARMA(p,q) specification can have real
or complex roots, while the trigonometric specification will only have
complex roots. The trigonometric specification is a special case of an
ARMA(2,1) specification.</p>
<p>If the roots are complex, the dynamics will be damped oscillations
about the trend, which may not always be desirable. If the user would
like to remove oscillations from the forecast that are caused by the
complex roots, the user can specify, <code>dampen_cycle = TRUE</code> in
<code>stsm_forecast</code>. This option will smooth the forecast of the
cycle into the trend using a fitted sigmoid curve.</p>
</div>
<div id="seasonal-model" class="section level2">
<h2>Seasonal Model</h2>
<p>Seasonality is modeled using a Fourier series, which is the sum of
sin-cos waves with each wave representing a seasonal pattern. Total
seasonality is <span class="math display">\[
s_t = \sum_{j = 1}^{h} s_t^j
\]</span></p>
<p>where each season <span class="math inline">\(s_t^j\)</span> is
modeled using the trigonometric specification below</p>
<p><span class="math display">\[
\begin{bmatrix}
s_t^j \\
s_t^{j,*}
\end{bmatrix} =
\begin{bmatrix}
cos(\lambda_j) &amp; sin(\lambda_j) \\
-sin(\lambda_j) &amp; cos(\lambda_j)
\end{bmatrix}
\begin{bmatrix}
s_{t-1}^j \\
s_{t-1}^{j,*}
\end{bmatrix} +
\begin{bmatrix}
w_t^j \\
w_t^{j,*}
\end{bmatrix}, w_t^j \sim N(0, \sigma_j^2)
\]</span> where <span class="math inline">\(s_t^{j,*}\)</span> exists by
construction and is just an auxiliary variable, <span class="math inline">\(\lambda_j = \frac{2\pi j}{f}\)</span> is the
frequency of season <span class="math inline">\(j\)</span>, <span class="math inline">\(j\)</span> represents the number of periods per
year (i.e. <span class="math inline">\(j = 52\)</span> represents weekly
seasonality at 52 periods per year), and <span class="math inline">\(f\)</span> is the frequency of the data (i.e. the
number of observations per year). The seasons to include in the model
are automatically detected in the algorithm using wavelet analysis. Each
<span class="math inline">\(\lambda_j\)</span> is predetermined from
wavelet analysis and are not estimated parameters.</p>
</div>
<div id="model-specification" class="section level2">
<h2>Model Specification</h2>
<p>The automatic model specification algorithm follows the procedure
below. Rather than using brute force selection by checking every
possible model combination and selecting the model that minimizes a
selection criteria like AIC, which can be computationally intensive and
time consuming, the procedure uses a series a statistical tests to
determine model specification. However, the user is free to write their
own brute force model selection routine from the functions provided in
this package as <code>stsm_estimate</code> returns a table with the
model’s log likelihood, AIC, AICc, and BIC.</p>
<div id="frequency-detection" class="section level3">
<h3>Frequency Detection</h3>
<p>The first step is to detect the frequency of the data by examining
the sequence of dates provided. If the day difference in subsequent
dates is closest to</p>
<ul>
<li><span class="math inline">\(1\)</span>, then a frequency of 365.25
is used for daily data</li>
<li><span class="math inline">\(7\)</span>, then a frequency of 52.17857
is used for weekly data</li>
<li><span class="math inline">\(30\)</span>, then a frequency of 12 is
used for monthly data</li>
<li><span class="math inline">\(90\)</span>, then a frequency of 4 is
used for quarterly data</li>
<li><span class="math inline">\(365\)</span>, then a frequency of 1 used
for yearly data</li>
</ul>
<p>It can also detect sub-daily data if the day difference in subsequent
dates is closest to - <span class="math inline">\(\frac{1}{24}\)</span>,
then a frequency of 8760 is used for hourly data - <span class="math inline">\(\frac{1}{60 \cdot 24}\)</span>, then a frequency
of 525600 is used for minutely data - <span class="math inline">\(\frac{1}{60 \cdot 60 \cdot 24}\)</span>, then a
frequency of 31536000 is used for secondly data</p>
<p>The numeric frequency reflects the number of periods in one year.
Once the frequency is detected, a sequence of continuous dates is
constructed to ensure evenly spaced data. If an observation is missing
for any of the dates in the constructed sequence, it is treated as a
missing value. However, if the dates provided contain only weekdays and
the data is of daily frequency for example, the frequency is changed to
<span class="math inline">\(365.25 \cdot \frac{5}{7} = 260.8929\)</span>
to reflect the number of weekdays per year. The same concept is applied
to sub-daily data with weekday observations only as well. If none of the
above frequencies are detected, then the frequency is set to the number
of rows in the data to allow the algorithm to search for seasonal
patterns. A flag <code>standard_freq</code> will be set to
<code>FALSE</code> in the final output.</p>
</div>
<div id="seasonal-and-cycle-adjustment" class="section level3">
<h3>Seasonal and Cycle Adjustment</h3>
<p>Before any of the model specification tests can be performed, the
data must be seasonally and cycle adjusted. This procedure is performed
by decomposing the time series into a loess trend and a seasonal-cycle
remainder. The <code>loess</code> function in the <code>stats</code>
package requires that there are no missing values in the data, so any
missing values are computed using the Kalman filter with a local trend
using the <code>stats</code> package’s <code>StructTS</code> and
<code>KalmanSmooth</code> functions. If you know the missing data
pattern in your data (i.e missing data should be 0), it’s best to fill
in the missing data using your knowledge before allowing this method to
fill in the rest. A smoother cycle is also estimated from the
seasonal-cycle component using a smoothing spline from the
<code>smooth.spline</code> function of the <code>stats</code> package.
Once the seasonal and cycle periods are known, the seasonal-cycle is
more accurately decomposed into the seasonal and cycle components by
first decomposing the seasonal-cycle using the <code>mstl</code>
function from the <code>forecast</code> package then regressing the
seasonal component on a Fourier series composed of the seasonal
periods.</p>
</div>
<div id="seasonality-detection" class="section level3">
<h3>Seasonality Detection</h3>
<p>The first step is wavelet analysis for seasonal detection, which is
done using a series of harmonic regressions in parallel on the detrended
data. The detrended data may also be rescaled by the trend if the
Cox-Stuart deviation test suggests that the detrended data does not have
a constant amplitude. The regression is performed individually for each
seasonal harmonic using the equation</p>
<p><span class="math display">\[
\tilde{y_t} = a_j sin(2\pi\frac{j}{f}) + b_j cos(2\pi\frac{j}{f})
\]</span></p>
<p>for harmonics <span class="math inline">\(j\)</span> that correspond
to the spectrum of minutely, hourly, workday hours, half daily, daily,
weekend, weekday, weekly, monthly, quarterly, semi-yearly, and yearly
seasonal frequencies where applicable. However, since this limits the
number of frequencies tested, a linear space of 100 items is created
between each harmonic so that the space captures 1% of the distance
between the original two harmonics. If a nonstandard frequency is
detected, the harmonics are set to <span class="math inline">\(j =
\lfloor \frac{f}{2} \rfloor\)</span>, but only taking 1000 equally
spaced harmonics for harmonics that have at least 3 cycles in the data.
This strategy limits the number of harmonics tested for speed, while
also trying to capture some a priori important seasonalities based on
the frequency of the data.</p>
<p>At each iteration, an F-test is performed using the
<code>waldtest</code> function from the <code>lmtest</code> package to
measure the significance of the harmonic in explaining the seasonality,
understanding that this will not be robust to heteroskedasticity or
autocorrelation. This accuracy is sacrificed for speed at this step. The
frequencies (defined as <span class="math inline">\(\frac{f}{j}\)</span>) are then matched to the
spectrum of seasonalities that correspond to the a priori important
seasonal spectrum if the frequency of the harmonic is within one delta
of the frequency of this predefined spectrum. This delta is equal to the
unique difference between the frequencies of the harmonics.</p>
<p>Lastly, backward stepwise regression procedure using an F-test for
the significance of each seasonality (i.e. joint significance of <span class="math inline">\(a_j\)</span> and <span class="math inline">\(b_j\)</span> is used to build the final
seasonality specification starting with only the harmonics that were
statistically significant from the first step. At each stage of the of
the stepwise procedure, an F-test for the statistical significance of
each seasonality is performed and any harmonics that are not
statistically significant are removed. The process is performed
iteratively until all remaining harmonics are statistically significant.
The F-tests for this procedure are calculated using HAC standard errors
to be robust to heteroskedasticity and autocorrelation to reduce the
chance of selecting spurious seasonalities.</p>
</div>
<div id="cycle-detection" class="section level3">
<h3>Cycle Detection</h3>
<p>Next, if <code>cycle = NULL</code>, wavelet analysis is performed to
detect a trigonometric form for the cycle. If one is not detected, it is
set to an ARMA(p,q) specification if the model prior for the cycle is
determined to be stationary. If <code>cycle = &quot;trig&quot;</code>, wavelet
analysis is performed to detect a trigonometric form, but if none is
detected, it will default to no cycle. If <code>cycle = &quot;arma&quot;</code>,
then wavelet analysis will not be performed and the cycle will be set
the ARMA(p,q) form. In addition to setting <code>cycle = &quot;arma&quot;</code>,
the user can set the parameter <code>arma = c(p = p, q = q)</code> to
specify a specific ARMA order, or if left as the default with p and q
set to <code>NA</code>, then the order will be auto-selected.</p>
<p>Wavelet analysis for cycle detection is done using a series of
harmonic regressions in parallel on the detrended data. The detrended
data may also be rescaled by the trend if the Cox-Stuart deviation test
suggests that the detrended data does not have a constant amplitude. The
regression is performed individually for each harmonic using the
equation</p>
<p><span class="math display">\[
\tilde{y_t} = a_j sin(2\pi\frac{j}{f}) + b_j cos(2\pi\frac{j}{f})
\]</span></p>
<p>for harmonics <span class="math inline">\(j = 0.01\)</span> to <span class="math inline">\(j = 0.99\)</span> for every 0.01 and truncated for
harmonics that correspond to periods <span class="math inline">\(\in [
2.5f, T]\)</span> and harmonics &lt; <span class="math inline">\(1/2\)</span> where <span class="math inline">\(T\)</span> is the length of the data.</p>
<p>At each iteration, an F-test is performed using the
<code>waldtest</code> function from the <code>lmtest</code> package to
measure the significance of the harmonic to explain the seasonality,
understanding that this will not be robust to heteroskedasticity or
autocorrelation. This accuracy is sacrificed for speed at this step.
Once all harmonics have been tested, the algorithm looks for a global
maximum from the power spectrum measured with the F-statistic that is
statistically significant.</p>
<p>Lastly, a final regression is performed with only the harmonic that
was selected from the first step. From this regression, the harmonic is
kept only if the cycle is statistically significant (i.e. <span class="math inline">\(a_j\)</span> and <span class="math inline">\(b_j\)</span> are jointly significant) as measured
by the F-test for the final harmonic regression. The F-test for this
step is calculated using HAC standard errors to be robust to
heteroskedasticity and autocorrelation to reduce the chance of selecting
spurious seasonalities.</p>
</div>
<div id="multiplicative-vs-additive-detection" class="section level3">
<h3>Multiplicative vs Additive Detection</h3>
<p>The third step in the model construction is to determine if the model
should be based on a multiplicative of additive model. However, after
the seasonal and cycle steps are completed, a new model prior is created
based on the seasonal and cycle periods detected. For a multiplicative
model, the data must all be positive and satisfy one of two tests. The
model is restricted to multiplicative of additive decomposition, rather
than allowing the full range of Box-Cox transformations, so that the
decomposition is easy to compare to the original time series. Additive
makes the decomposition comparative in levels, multiplicative makes the
decomposition comparative in percentages relative to the original time
series, but Box-Cox transformations don’t have an easy interpretation
like this. However, the user can Box-Cox transform the data prior to
estimation and specify <code>multilicative = FALSE</code> if that method
is preferred.</p>
<div id="trend-test" class="section level4">
<h4>Trend Test</h4>
<p>First, is a test of a linear vs exponential trend. This test compares
the log likelihood of 1) a linear regression of the seasonal and cycle
adjusted data vs a linear trend, and 2) a linear regression of the
logged seasonal and cycle adjusted data vs a linear trend using the
<code>petest</code> from the <code>lmtest</code> package with
heteroskedastic and autocorrelated standard errors using the
<code>sandwich</code> package’s <code>vcovHAC</code> function. A log
trend model is selected if and only if the linear model is rejected and
the log model is not rejected.</p>
</div>
<div id="seasonal-cycle-amplitude-test" class="section level4">
<h4>Seasonal-Cycle Amplitude Test</h4>
<p>Next, is a test for constant seasonal and cycle amplitudes using the
Cox-Stuart deviation test on the detrended (and de-seasonalized or
de-cycled) data. Then, if the seasonal component is determined to have
changing amplitude, a multiplicative model is used. However, since this
test is sensitive to outliers, outliers in the seasonal and cycle series
are detected and replaced using the <code>forecast</code>’s package
<code>tsclean</code> function without replacing missing values before
the test is performed.</p>
</div>
</div>
<div id="trend-detection" class="section level3">
<h3>Trend Detection</h3>
<p>The final step is to determine the specification of the trend after
adjusting for the cycle and seasonality detected from the prior steps.
This mainly boils down to determining if the data is integrated of order
0, 1, or 2 (I(0), I(1), or I(2)). To determine the number of differences
to make the data stationary, the ADF, PP, and KPSS tests are performed
on the seasonal and cycle adjusted data using the <code>forecast</code>
package’s <code>ndiffs</code> functions on the seasonal adjusted time
series. However, since this test is sensitive to outliers, outliers in
the seasonal and cycle adjusted series are detected and replaced using
the <code>forecast</code>’s package <code>tsclean</code> function
without replacing missing values before the test is performed.</p>
<p>The number of differences selected for the trend specification is the
average number of differences across the tests, rounded to the nearest
digit. Next, the Cox-Stuart trend test is preformed on the seasonal and
cycle adjusted data to determine if the data is trending. If the data is
trending, the order of integration is set to at least 1.</p>
<p>If the order of integration is set to 1 at this point, the algorithm
will then check for structural breaks in the drift using the
<code>breakpoints</code> function from the <code>strucchange</code>
package as long as the minimum prior drift is below 0. If the average
value of the prior drift changes sign (from positive to negative, or
negative to positive) between break segments, then the order of
integration is set to 2.</p>
<p>If the data is determined to be</p>
<ul>
<li>I(2) then the “double-random-walk” specification is used</li>
<li>I(1) with a trend, then the “random-walk-drift” specification is
used</li>
<li>I(1) without a trend, then the “random-walk” specification is
used</li>
<li>I(0) and no trend, then the “random-walk” trend specification with a
deterministic trend is used to model a constant mean with an
autoregressive component</li>
</ul>
</div>
</div>
<div id="the-kalman-filter" class="section level2">
<h2>The Kalman Filter</h2>
<p>To estimate the unobserved components (<span class="math inline">\(T_t, C_t, S_t\)</span>, and <span class="math inline">\(D_t\)</span>), the Kalman filter is utilized. The
Kalman filter is a forward two-stage procedure that is the optimal
linear filter based on the multivariate normal distribution. The
“forwardness” of the filter means that it uses only data up to time
<span class="math inline">\(t\)</span> to make an inference on the
unobserved components at time <span class="math inline">\(t\)</span> and
does peak into the future to make that inference.</p>
<div id="prediction-stage" class="section level3">
<h3>Prediction Stage</h3>
<p>The first stage is the prediction stage, which makes predictions of
the state components based on information up to time <span class="math inline">\(t-1\)</span>. This stage is made up of four
equations, the first is the prediction of the state components based on
its time series properties</p>
<p><span class="math display">\[
B_{t|t-1} = D + F \beta_{t-1|t-1} + B^s X^s_t
\]</span></p>
<p>Second, is the prediction of the covariance matrix of the state
components</p>
<p><span class="math display">\[
P_{t|t-1} = F P_{t_1|t-1} F^{\prime} + Q
\]</span></p>
<p>Third, is the prediction error of the time series of interest</p>
<p><span class="math display">\[
\eta_{t|t-1} = Y_t - (A + H \beta_{t|t-1} + B^o X^o_t)
\]</span></p>
<p>And finally, we have the variance of the prediction error</p>
<p><span class="math display">\[
f_{t|t-1} = H P_{t|t-1} H^{\prime} + R
\]</span></p>
</div>
<div id="updating-stage" class="section level3">
<h3>Updating Stage</h3>
<p>The second stage is the updating stage, which makes predictions based
on all information up to time <span class="math inline">\(t\)</span>. It
consists of three equations. The first equation is the prediction of the
state components based on the the full information set</p>
<p><span class="math display">\[
\beta_{t|t} = B_{t|t-1} + K_t \eta_{t|t-1}
\]</span> where <span class="math inline">\(K_t\)</span> is the Kalman
gain, which determines the optimal weight to give new information in
making predictions about <span class="math inline">\(\beta_t\)</span>
and is the second equation</p>
<p><span class="math display">\[
K_t = P_{t|t-1} H^{\prime} f_{t|t-1}^{-1}
\]</span> The last equation is the updating of the covariance matrix of
the unobserved components</p>
<p><span class="math display">\[
P_{t|t} = P_{t|t-1} - K_t H^{\prime} P_{t|t-1}
\]</span> The seven equations above, make up the full Kalman filter
routine. If <span class="math inline">\(Y_t\)</span> is missing for any
observation, then</p>
<p><span class="math display">\[
B_{t|t} = B_{t|t-1} \\
P_{t|t} = P_{t|t-1} \\
K_t = 0 \\
f_{t|t-1} = \infty
\]</span></p>
</div>
<div id="kalman-smoothing" class="section level3">
<h3>Kalman Smoothing</h3>
<p>Once the Kalman filter is applied to the data, a smoothing procedure
can be applied in the backward direction to make a better inference of
the state components based on the entire data set. Unlike the filter,
the smoother does peak into the future to make an inference of the state
components at time <span class="math inline">\(t\)</span>. This
procedure consists of only two equations.</p>
<p>The first equation updates the prediction of the state components
based on all the available information</p>
<p><span class="math display">\[
\beta_{t|T} = \beta_{t|t} + P_{t|t} F^{\prime} P_{t|t}^{-1}
(\beta_{t+1|T} - \beta_{t+1|t})
\]</span></p>
<p>The second equation updates the covariance matrix of the state
components based on all the available information</p>
<p><span class="math display">\[
P_{t|T} = P_{t|t} + P_{t|t} F^{\prime} P_{t+1|t}^{-1} (P_{t+1|T} -
P_{t+1|t}) P_{t+1|t}^{-1 \prime} F P_{t|t}^{\prime}
\]</span></p>
</div>
</div>
<div id="maximum-likelihood-estimation" class="section level2">
<h2>Maximum Likelihood Estimation</h2>
<p>The model above is estimated using MLE with box constraints. The log
likelihood is given by</p>
<p><span class="math display">\[
ln(L(\theta)) = -\frac{1}{2} \sum_{t=1}^T \ln(|f_{t|t-1}|) -
\frac{1}{2}\sum_{t=1}^T \eta_{t|t-1}^{\prime} f_{t|t-1}^{-1}
\eta_{t|t-1}
\]</span></p>
</div>
<div id="initial-parameter-values" class="section level2">
<h2>Initial Parameter Values</h2>
<div id="model-prior" class="section level3">
<h3>Model Prior</h3>
<p>Initial parameter values are essential for finding a good model when
using maximum likelihood estimation. To this end, the algorithm uses
initial parameter values derived from a decomposition using the
<code>mstl</code> function, which acts like the model prior and is
represented by</p>
<p><span class="math display">\[
Y_t^* = T_t^* + C_t^* + S_t^* + e_t^*
\]</span></p>
<p>This function will decompose the time series into trend and
seasonality. The seasonality is then further split into the seasonal
harmonics by fitted a linear regression on the seasonal Fourier series
and extracting the fitted components. Finally, the trend is further
split into a smoother trend and the cycle by fitting a loess trend to
the <code>mstl</code> trend using the <code>loess</code> function. The
drift is then derived by taking the first difference of the trend.</p>
</div>
<div id="trend-and-drift-initial-values" class="section level3">
<h3>Trend and Drift Initial Values</h3>
<p>These parameters are set initial to match to the theoretical variance
of the model depending on the trend type. If the trend is set to
“random-walk” then <span class="math inline">\(\sigma_t = sd(\Delta
T_t^{*})\)</span>. If the trend is set to “double-random-walk” then
<span class="math inline">\(\sigma_t = \sigma_d = sd(\Delta
T_t^{*})/sqrt(2)\)</span>. If the trend is set to “random-walk-drift”,
an AR(1) model is fit the drift prior, <span class="math inline">\(\sigma_d\)</span> is set to the standard deviation
of the model errors, <span class="math inline">\(\phi_d\)</span> is the
set to the estimated AR(1) parameter, and <span class="math inline">\(\sigma_t\)</span> is set to <span class="math inline">\(\sqrt{var(\Delta T_t^*) - \frac{\sigma_d^2}{1 -
\phi_d^2}}\)</span> the theoretical variance if the trend is I(1).</p>
</div>
<div id="cycle-initial-values" class="section level3">
<h3>Cycle Initial Values</h3>
<p>If the cycle model is set to the ARMA(p,q) specification or a cycle
is not detected, <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> are determined using the
<code>forecast</code> package’s <code>auto.arima</code> function on the
prior cycle. The estimated AR and MA components are then used as the
initial parameters. If the cycle is model is set to the trigonometric
specification, <span class="math inline">\(\lambda\)</span> is set to be
<span class="math inline">\(\frac{2\pi}{c}\)</span> where <span class="math inline">\(c\)</span> is the estimated cycle period. <span class="math inline">\(\phi_c\)</span> is set to the maximum eigenvalue
of an ARMA(2,0,1) process fit to the cycle prior as this is related to
the speed of convergence towards the trend as <span class="math inline">\(\phi_c\)</span> is in an AR(1) process. Finally,
<span class="math inline">\(\sigma_c\)</span> is set to the standard
deviation of the model errors.</p>
</div>
<div id="seasonality-initial-values" class="section level3">
<h3>Seasonality Initial Values</h3>
<p>If seasonality is included, each <span class="math inline">\(\sigma_j\)</span> is set to <span class="math inline">\(sd(\Delta S_t^*)/sqrt(h)\)</span> where h is the
number of seasonal harmonics so <span class="math inline">\(var(\Delta
S_t^*) = \sum_j \sigma_j^2\)</span></p>
</div>
<div id="remainder" class="section level3">
<h3>Remainder</h3>
<p>Lastly, <span class="math inline">\(\sigma_e\)</span> is set the the
standard deviation of the remainder of the model prior, <span class="math inline">\(sd(e_t^*)\)</span>.</p>
</div>
<div id="unobserved-component-initial-values" class="section level3">
<h3>Unobserved Component Initial Values</h3>
<p>The initial values of the unobserved components must also be
initialized. These values are not optimized but set in advance to aid in
speed. The only value set to optimize is one value for the diagonal of
the covariance matrix <span class="math inline">\(P_{0|0}\)</span>,
which is set to the identity matrix. The initial values for the
unobserved components are taken to be the first non-NA value for each
series from the prior.</p>
</div>
<div id="box-constraints" class="section level3">
<h3>Box Constraints</h3>
<p>The box constraints act like priors and provide bounds on parameter
estimates to ensure a reasonable model. The constraints include
stationarity constraints for the trigonometric cycle, <span class="math inline">\(0 &lt; \phi_c &lt; 1\)</span>, autoregressive
cycle <span class="math inline">\(0 &lt; \sum \phi_{c,i} &lt;
1\)</span>, moving average component <span class="math inline">\(0 &lt;
\sum \theta_{c,i} &lt; 1\)</span>, drift <span class="math inline">\(-1
&lt; \phi_d &lt; 1\)</span>, as well as <span class="math inline">\(\sigma_x &gt; 0\)</span> for all variance
parameters. Trend smoothness constraints</p>
<p><span class="math display">\[
\sigma_t + \sigma_d &lt; \sigma_e \\
\sigma_t + \sigma_d &lt; \sigma_c \\
\sigma_t + \sigma_d &lt; \sum_j \sigma_j
\]</span></p>
<p>are also included to ensure that the trend accounts for the least
variability among all the components. It can be relaxed by setting
<code>unconstrained = TRUE</code> in <code>stsm_estimate</code>.</p>
</div>
<div id="interpolation-models" class="section level3">
<h3>Interpolation Models</h3>
<p>If an interpolation model is specified, the model is redefined based
on the values set in <code>interpolate</code> and
<code>interpolate_method</code>. For all interpolation models,</p>
<p><span class="math display">\[
I_t = T_{t-1} + S_{t-1} + C_{t-1}
\]</span> where <span class="math inline">\(I_t\)</span> is the
interpolated series and a deterministic observation equation is used by
setting <span class="math inline">\(\sigma_e = 0\)</span>. The only
other that changes is the specification of the observation equation,
which is determined by the interpolation method</p>
<ul>
<li>End of period, then <span class="math inline">\(Y_t =
I_t\)</span></li>
<li>Period average, then <span class="math inline">\(Y_t =
\frac{1}{N}(I_t + \ldots + I_{t-N+1})\)</span></li>
<li>Period sum, then <span class="math inline">\(Y_t = I_t + \ldots +
I_{t-N+1}\)</span></li>
</ul>
<p>where <span class="math inline">\(N\)</span> is the period to
interpolate over. For example, if the frequency of the data is quarterly
and the user would like to interpolate the data to a monthly frequency,
then <span class="math inline">\(N = 3\)</span>.</p>
<p>The interpolation frequency is set by specifying
<code>interpolate</code> to “quarterly”, “monthly”, “weekly”, or “daily”
as long as that frequency is higher than the frequency of the data.
Although, it is recommended to only interpolate one frequency higher
than the frequency of the data.</p>
<p>Interpolation methods are defined by setting
<code>interpolate_method</code> to “eop” for end of period, “avg” for
period average, and “sum” for period sum.</p>
<p>Interpolation errors will depend on the volatility of the time series
as well as model misspecification. However, given the model, the end of
period method will be more susceptible to errors due to volatility than
either the average or sum methods.</p>
</div>
</div>
<div id="anomaly-detection" class="section level2">
<h2>Anomaly Detection</h2>
<p>Anomaly detection uses the estimated structural model and the
recursive nature of the Kalman filter to detect observations that are
outside a given threshold of the model’s predicted values for time <span class="math inline">\(t\)</span> given the data and estimates of the
unobserved components at time <span class="math inline">\(t-1\)</span>.
The threshold is determined by the forecast error variance of the
estimated structural model. Anomalies that are detected can then be
replaced with the modeled predicted values or threshold if the user
wants to replace outliers.</p>
<p>It is important to note that anomalies are detected by comparison to
the model, which is based on normally distributed innovations. Thus, the
interpretation of an anomaly here is a value that has an “x” percent
chance of occurring based on the data being generated from normal
innovations, where the “x” percent is determined by the threshold.
Normal distributions may not be appropriate for all time series, but
this method of anomaly detection could be used to tell the user about
the validity of the normality assumption: i.e. if more than 1% of the
sample is detected as an anomaly with a 99% threshold, then normality
may not be the best assumption for innovations for that particular
series.</p>
<p><code>stsm_detect_anomalies</code> will only plot if anomalies are
detected and <code>plot = TRUE</code>.</p>
<p>The model makes recursive predictions for the j-th step ahead
using</p>
<p><span class="math display">\[
\hat{Y_{t+j}} = H F^j \beta_{t}
\]</span> since <span class="math inline">\(A = 0\)</span> and <span class="math inline">\(D = 0\)</span> for this model. The j-step ahead
forecast error variance is given by</p>
<p><span class="math display">\[
FEV = \left(\sum_{i=0}^{j-1} H F^i Q F^{i\prime} H^{\prime}\right) + R
\]</span> The error variance is based on the assumption of linearity and
normality, as the Kalman filter is a linear Gaussian filter, so the
confidence intervals should be understood to be a lower bound as the
decomposition is a simplification of an arguable more complex process.
The uncertainty lost in that abstraction to linearity is not
quantifiable, and uncertainty will be lost in the simplification from a
stochastic process with excess kurtosis or skewness to normality.</p>
</div>
<div id="structural-break-detection" class="section level2">
<h2>Structural Break Detection</h2>
<p>Structural breaks are detected using the <code>breakpoints</code>
function from the <code>strucchange</code> package. It attempts to
detect structural breaks in the trend, cycle, and seasonalities based on
the estimated structural model. These tests can show how well the
stochastic nature of the model picks up on the time varying nature of
the time series.</p>
<p>If the data has an upward (or downward trend), the algorithm will
look for breaks in trend growth. Otherwise, it will look for breaks in
the level of the trend. If the growth (or level) is not constant across
the entire time series, then a break should be detected.</p>
<p>Structural breaks in the seasonality and cycle are detected by
looking for changes in the mean absolute value of the seasonal series
(an analog for the amplitude). To check from breaks in the amplitude, a
simple test on the mean absolute value is performed as this is related
to the amplitude via the relationship <span class="math inline">\(Avg(|x_t|) = \frac{2}{\pi}Amp\)</span>. If the
amplitude is not stable across the entire series, then a break should be
detected.</p>
<p>Seasonality is defined by a constant periodicity, but economic cycles
are rarely constant in their periodicity. So, a second structural break
test is used on the cycle to check for changes in the periodicity. To
check for breaks in the periodicity, the cycle is modeled using the
trigonometric structure described above (<span class="math inline">\(C_t
= \phi_c cos(\lambda_t) C_{t-1} + \phi_c sin(\lambda_t) C_{t-1}^{*} = a
C_{t-1} + b C_{t-1}^{*}\)</span>) and looking for instabilities in the
coefficients over the time sample. The periodicity is identified from
the linear regression using the relationship <span class="math inline">\(period =
\frac{2\pi}{tan^{-1}(\frac{b}{a})}\)</span>. If the coefficients of this
model are not stable across the entire series, then a break should be
detected.</p>
<p>This procedure can be time consuming, even with high performance
parallel computing, so if the user is only interested in structural
breaks for a particular component, the user can specify the
<code>components</code> arguments of <code>stsm_detect_breaks</code> to
be any combination of “trend”, “cycle”, and “seasonal”.
<code>stsm_detect_breaks</code> will only plot the breaks that are
detected if <code>plot = TRUE</code>.</p>
</div>
</div>
<div id="example-usage" class="section level1">
<h1>Example Usage</h1>
<p>Below is an example of how to use this package:</p>
<div id="simulated-data-decomposition" class="section level2">
<h2>Simulated Data Decomposition</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(autostsm)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1024</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Daily data</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>freq <span class="ot">=</span> <span class="fl">365.25</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Build the trend and drift</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>t <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>t[<span class="dv">1</span>] <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>m[<span class="dv">1</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>sig_e <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>sig_t <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>sig_m <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>sig_s <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3000</span>){</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  m[i] <span class="ot">=</span> <span class="fl">0.05</span> <span class="sc">+</span> <span class="fl">0.75</span><span class="sc">*</span>m[i<span class="dv">-1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sig_m)</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  t[i] <span class="ot">=</span> t[i<span class="dv">-1</span>] <span class="sc">+</span> m[i<span class="dv">-1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sig_t)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">#Build the seasonality including yearly and weekly </span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>s365 <span class="ot">=</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span>freq<span class="sc">*</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t))) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(t), <span class="dv">0</span>, sig_s)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>s365 <span class="ot">=</span> (s365 <span class="sc">-</span> <span class="fu">min</span>(s365))<span class="sc">/</span><span class="fu">diff</span>(<span class="fu">range</span>(s365))<span class="sc">*</span>(<span class="fl">1.125</span> <span class="sc">-</span> <span class="fl">0.865</span>) <span class="sc">+</span> <span class="fl">0.865</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>s7 <span class="ot">=</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">7</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t))) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(t), <span class="dv">0</span>, sig_s)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>s7 <span class="ot">=</span> (s7 <span class="sc">-</span> <span class="fu">min</span>(s7))<span class="sc">/</span><span class="fu">diff</span>(<span class="fu">range</span>(s7))<span class="sc">*</span>(<span class="fl">1.125</span> <span class="sc">-</span> <span class="fl">0.865</span>) <span class="sc">+</span> <span class="fl">0.865</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>s <span class="ot">=</span> s365 <span class="sc">+</span> s7</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>s <span class="ot">=</span> (s <span class="sc">-</span> <span class="fu">min</span>(s))<span class="sc">/</span><span class="fu">diff</span>(<span class="fu">range</span>(s))<span class="sc">*</span>(<span class="fl">1.25</span> <span class="sc">-</span> <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">0.75</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="co">#Build the cyclicality using every 3 years periodicity</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>c <span class="ot">=</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span><span class="fl">0.33</span><span class="sc">/</span>freq<span class="sc">*</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t))) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(t), <span class="dv">0</span>, sig_s)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>c <span class="ot">=</span> (c <span class="sc">-</span> <span class="fu">min</span>(c))<span class="sc">/</span><span class="fu">diff</span>(<span class="fu">range</span>(c))<span class="sc">*</span>(<span class="fl">1.25</span> <span class="sc">-</span> <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">0.75</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co">#Build the data using a multiplicative model</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(<span class="st">&quot;2016-01-01&quot;</span>) <span class="sc">+</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t), </span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> t<span class="sc">*</span>c<span class="sc">*</span>s<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="fu">length</span>(t), <span class="dv">0</span>, sig_e)), </span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>                <span class="at">trend =</span> t, <span class="at">seasonal =</span> s, <span class="at">seasonal7 =</span> s7, </span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>                <span class="at">seasonal365 =</span> s365, <span class="at">cycle =</span> c)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co">#Create some missing values</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>ts[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(ts), <span class="fu">round</span>(<span class="fl">0.05</span><span class="sc">*</span><span class="fu">nrow</span>(ts))), <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="cn">NA</span>]</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="co">#View the data</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">melt</span>(ts, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">&quot;y&quot;</span>, <span class="st">&quot;trend&quot;</span>))) <span class="sc">+</span> </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Observed vs Trend&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> </span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">melt</span>(ts, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">&quot;cycle&quot;</span>))) <span class="sc">+</span> </span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Cycle&quot;</span>) <span class="sc">+</span> </span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> </span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>g3 <span class="ot">=</span> <span class="fu">ggplot</span>(<span class="fu">melt</span>(ts, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>, <span class="at">measure.vars =</span> <span class="fu">colnames</span>(ts)[<span class="fu">grepl</span>(<span class="st">&quot;seasonal&quot;</span>, <span class="fu">colnames</span>(ts))])) <span class="sc">+</span> </span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Seasonal&quot;</span>) <span class="sc">+</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> </span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(g1, g2, g3, <span class="at">layout_matrix =</span> <span class="fu">rbind</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>)))</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimate the model</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="co">#Forecast and plot the results</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_forecast</span>(stsm, <span class="at">y =</span> ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">n.ahead =</span> <span class="fu">floor</span>(stsm<span class="sc">$</span>freq)<span class="sc">*</span><span class="dv">3</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="co">#Detect anomalies</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_anomalies</span>(stsm, <span class="at">y =</span> ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">plot =</span> <span class="cn">TRUE</span>), </span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="co">#Detect structural breaks</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_breaks</span>(stsm, <span class="at">y =</span> ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>), </span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="using-exogenous-data" class="section level2">
<h2>Using Exogenous Data</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(autostsm)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Define the exogenous data</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>exo_obs <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">date =</span> ts<span class="sc">$</span>date, <span class="at">Xo =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(ts)))</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>exo_state <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">date =</span> ts<span class="sc">$</span>date, <span class="at">Xs_trend =</span> <span class="fu">rnorm</span>(<span class="fu">nrow</span>(ts)), </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">Xs_seasonal =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(ts)))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>exo_state[<span class="fu">seq</span>(<span class="dv">1</span>, .N, <span class="at">by =</span> <span class="dv">7</span>), <span class="st">&quot;Xs_seasonal&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="dv">1</span>]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#Estimate the model</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">exo_obs =</span> exo_obs, <span class="at">exo_state =</span> exo_state, </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">state_eqns =</span> <span class="fu">c</span>(<span class="st">&quot;trend ~ Xs_trend - 1&quot;</span>, <span class="st">&quot;seasonal ~ Xs_seasonal - 1&quot;</span>), </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Check the exogenous parameter estimates</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">stsm_ssm</span>(<span class="at">model =</span> stsm)[<span class="fu">c</span>(<span class="st">&quot;betaO&quot;</span>, <span class="st">&quot;betaS&quot;</span>)]</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">#Filter and plot the results</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_filter</span>(stsm, <span class="at">y =</span> ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                      <span class="at">exo_obs =</span> exo_obs, <span class="at">exo_state =</span> exo_state, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">#Detect anomalies</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_anomalies</span>(stsm, <span class="at">y =</span> ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], </span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">exo_obs =</span> exo_obs, <span class="at">exo_state =</span> exo_state, <span class="at">plot =</span> <span class="cn">TRUE</span>), </span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">#Detect structural breaks</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_breaks</span>(stsm, <span class="at">y =</span> ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">exo_obs =</span> exo_obs, <span class="at">exo_state =</span> exo_state, </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>), </span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="real-data-decompositions" class="section level2">
<h2>Real Data Decompositions</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(autostsm)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="do">##### Unemployment rate examples #####</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Not seasonally adjusted</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;UNRATENSA&quot;</span>, <span class="at">package =</span> <span class="st">&quot;autostsm&quot;</span>) <span class="co">#From FRED</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>UNRATENSA <span class="ot">=</span> <span class="fu">data.table</span>(UNRATENSA, <span class="at">keep.rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(UNRATENSA) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>UNRATENSA[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>UNRATENSA[, <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(y)]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(UNRATENSA, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_forecast</span>(stsm, <span class="at">y =</span> UNRATENSA, <span class="at">n.ahead =</span> <span class="fu">floor</span>(stsm<span class="sc">$</span>freq)<span class="sc">*</span><span class="dv">3</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_anomalies</span>(stsm, <span class="at">y =</span> UNRATENSA, <span class="at">plot =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_breaks</span>(stsm, <span class="at">y =</span> UNRATENSA, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">#Seasonally adjusted</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;UNRATE&quot;</span>, <span class="at">package =</span> <span class="st">&quot;autostsm&quot;</span>) <span class="co">#From FRED</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>UNRATE <span class="ot">=</span> <span class="fu">data.table</span>(UNRATE, <span class="at">keep.rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(UNRATE) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>UNRATE[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>UNRATE[, <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(y)]</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(UNRATE, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_forecast</span>(stsm, <span class="at">y =</span> UNRATE, <span class="at">n.ahead =</span> <span class="fu">floor</span>(stsm<span class="sc">$</span>freq)<span class="sc">*</span><span class="dv">3</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_anomalies</span>(stsm, <span class="at">y =</span> UNRATE, <span class="at">plot =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_breaks</span>(stsm, <span class="at">y =</span> UNRATE, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="do">##### GDP examples #####</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co">#Not seasonally adjusted</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;NA000334Q&quot;</span>, <span class="at">package =</span> <span class="st">&quot;autostsm&quot;</span>) <span class="co">#From FRED</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>NA000334Q <span class="ot">=</span> <span class="fu">data.table</span>(NA000334Q, <span class="at">keep.rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(NA000334Q) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>NA000334Q[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>NA000334Q[, <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(y)]</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>NA000334Q <span class="ot">=</span> NA000334Q[date <span class="sc">&gt;=</span> <span class="st">&quot;1990-01-01&quot;</span>, ]</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(NA000334Q, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_forecast</span>(stsm, <span class="at">y =</span> NA000334Q, <span class="at">n.ahead =</span> <span class="fu">floor</span>(stsm<span class="sc">$</span>freq)<span class="sc">*</span><span class="dv">3</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_anomalies</span>(stsm, <span class="at">y =</span> NA000334Q, <span class="at">plot =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_breaks</span>(stsm, <span class="at">y =</span> NA000334Q, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co">#Seasonally adjusted</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;GDP&quot;</span>, <span class="at">package =</span> <span class="st">&quot;autostsm&quot;</span>) <span class="co">#From FRED</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>GDP <span class="ot">=</span> <span class="fu">data.table</span>(GDP, <span class="at">keep.rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(GDP) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>GDP[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>GDP[, <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(y)]</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>GDP <span class="ot">=</span> GDP[date <span class="sc">&gt;=</span> <span class="st">&quot;1990-01-01&quot;</span>, ]</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(GDP, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_forecast</span>(stsm, <span class="at">y =</span> GDP, <span class="at">n.ahead =</span> <span class="fu">floor</span>(stsm<span class="sc">$</span>freq)<span class="sc">*</span><span class="dv">3</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_anomalies</span>(stsm, <span class="at">y =</span> GDP, <span class="at">plot =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_breaks</span>(stsm, <span class="at">y =</span> GDP, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="do">##### S&amp;P 500 example #####</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;SP500&quot;</span>, <span class="at">package =</span> <span class="st">&quot;autostsm&quot;</span>) <span class="co">#From FRED</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>SP500 <span class="ot">=</span> <span class="fu">data.table</span>(SP500, <span class="at">keep.rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(SP500) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>SP500[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>SP500[, <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(y)]</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(SP500, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_forecast</span>(stsm, <span class="at">y =</span> SP500, <span class="at">n.ahead =</span> <span class="fu">floor</span>(stsm<span class="sc">$</span>freq)<span class="sc">*</span><span class="dv">3</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_anomalies</span>(stsm, <span class="at">y =</span> SP500, <span class="at">plot =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_breaks</span>(stsm, <span class="at">y =</span> SP500, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a><span class="do">##### 5 Year Treasury Yield example #####</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;DGS5&quot;</span>, <span class="at">package =</span> <span class="st">&quot;autostsm&quot;</span>) <span class="co">#From FRED</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>DGS5 <span class="ot">=</span> <span class="fu">data.table</span>(DGS5, <span class="at">keep.rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(DGS5) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>DGS5[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>DGS5[, <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(y)]</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(DGS5, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_forecast</span>(stsm, <span class="at">y =</span> DGS5, <span class="at">n.ahead =</span> <span class="fu">floor</span>(stsm<span class="sc">$</span>freq)<span class="sc">*</span><span class="dv">3</span>, <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_anomalies</span>(stsm, <span class="at">y =</span> DGS5, <span class="at">plot =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc, </span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>                <span class="fu">stsm_detect_breaks</span>(stsm, <span class="at">y =</span> DGS5, <span class="at">plot =</span> <span class="cn">TRUE</span>, <span class="at">show_progress =</span> <span class="cn">TRUE</span>), </span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>                <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="simulated-data-interpolation" class="section level2">
<h2>Simulated Data Interpolation</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(autostsm)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Rebuild the data</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1024</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#Daily data</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>freq <span class="ot">=</span> <span class="fl">365.25</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">#Build the trend and drift</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>t <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>t[<span class="dv">1</span>] <span class="ot">=</span> <span class="dv">100</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>m[<span class="dv">1</span>] <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>sig_e <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>sig_t <span class="ot">=</span> <span class="dv">1</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>sig_m <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>sig_s <span class="ot">=</span> <span class="fl">0.01</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="dv">3000</span>){</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  m[i] <span class="ot">=</span> <span class="fl">0.05</span> <span class="sc">+</span> <span class="fl">0.75</span><span class="sc">*</span>m[i<span class="dv">-1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sig_m)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  t[i] <span class="ot">=</span> t[i<span class="dv">-1</span>] <span class="sc">+</span> m[i<span class="dv">-1</span>] <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, sig_t)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">#Build the seasonality including yearly and weekly </span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>s365 <span class="ot">=</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span>freq<span class="sc">*</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t))) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(t), <span class="dv">0</span>, sig_s)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>s365 <span class="ot">=</span> (s365 <span class="sc">-</span> <span class="fu">min</span>(s365))<span class="sc">/</span><span class="fu">diff</span>(<span class="fu">range</span>(s365))<span class="sc">*</span>(<span class="fl">1.125</span> <span class="sc">-</span> <span class="fl">0.865</span>) <span class="sc">+</span> <span class="fl">0.865</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>s7 <span class="ot">=</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">/</span><span class="dv">7</span><span class="sc">*</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t))) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(t), <span class="dv">0</span>, sig_s)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>s7 <span class="ot">=</span> (s7 <span class="sc">-</span> <span class="fu">min</span>(s7))<span class="sc">/</span><span class="fu">diff</span>(<span class="fu">range</span>(s7))<span class="sc">*</span>(<span class="fl">1.125</span> <span class="sc">-</span> <span class="fl">0.865</span>) <span class="sc">+</span> <span class="fl">0.865</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>s <span class="ot">=</span> s365 <span class="sc">+</span> s7</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>s <span class="ot">=</span> (s <span class="sc">-</span> <span class="fu">min</span>(s))<span class="sc">/</span><span class="fu">diff</span>(<span class="fu">range</span>(s))<span class="sc">*</span>(<span class="fl">1.25</span> <span class="sc">-</span> <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">0.75</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="co">#Build the cyclicality using every 3 years periodicity</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>c <span class="ot">=</span> <span class="fu">sin</span>(<span class="dv">2</span><span class="sc">*</span>pi<span class="sc">*</span><span class="fl">0.33</span><span class="sc">/</span>freq<span class="sc">*</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t))) <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(t), <span class="dv">0</span>, sig_s)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>c <span class="ot">=</span> (c <span class="sc">-</span> <span class="fu">min</span>(c))<span class="sc">/</span><span class="fu">diff</span>(<span class="fu">range</span>(c))<span class="sc">*</span>(<span class="fl">1.25</span> <span class="sc">-</span> <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">0.75</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co">#Build the data using a multiplicative model</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">=</span> <span class="fu">data.table</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(<span class="st">&quot;2016-01-01&quot;</span>) <span class="sc">+</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(t), </span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> t<span class="sc">*</span>c<span class="sc">*</span>s<span class="sc">*</span><span class="fu">exp</span>(<span class="fu">rnorm</span>(<span class="fu">length</span>(t), <span class="dv">0</span>, sig_e)))</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="co">#Convert the data to monthly by using the end of period</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>ts[, <span class="st">&quot;mnth&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">floor_date</span>(date, <span class="st">&quot;month&quot;</span>)]</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>ts[, <span class="st">&quot;rn&quot;</span> <span class="sc">:</span><span class="er">=</span> .N<span class="sc">:</span><span class="dv">1</span>, by <span class="ot">=</span> <span class="st">&quot;mnth&quot;</span>]</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">=</span> ts[rn <span class="sc">==</span> <span class="dv">1</span>, <span class="fu">c</span>(<span class="st">&quot;mnth&quot;</span>, <span class="st">&quot;y&quot;</span>), with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(ts)[<span class="fu">colnames</span>(ts) <span class="sc">==</span> <span class="st">&quot;mnth&quot;</span>] <span class="ot">=</span> <span class="st">&quot;date&quot;</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="co">#Get the quarter and set the date to be the end of the quarter</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>ts[, <span class="st">&quot;qtr&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">ceiling_date</span>(date, <span class="st">&quot;quarter&quot;</span>) <span class="sc">%m-%</span> <span class="fu">months</span>(<span class="dv">1</span>)]</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>ts[, <span class="st">&quot;y_avg&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollmean</span>(y, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>ts[, <span class="st">&quot;y_sum&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(y, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="co">#We already know the data has a multiplicative structure with yearly seasonality and </span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a><span class="co">#the frequency below will be set to quarterly, </span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a><span class="co">#so we will set seasons = 4 and multiplicative to TRUE to help the model with identification</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="co">#since the data set goes from 3000 daily observations to 99 monthly observations and then to</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="co">#33 quarterly observations</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="co">#End of period</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>ts[, <span class="st">&quot;rn&quot;</span> <span class="sc">:</span><span class="er">=</span> .N<span class="sc">:</span><span class="dv">1</span>, by <span class="ot">=</span> <span class="st">&quot;qtr&quot;</span>]</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>ts.eop <span class="ot">=</span> ts[rn <span class="sc">==</span> <span class="dv">1</span>, ][, <span class="st">&quot;rn&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(<span class="at">y =</span> ts.eop[, <span class="fu">c</span>(<span class="st">&quot;qtr&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">seasons =</span> <span class="dv">4</span>, <span class="at">multiplicative =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>                     <span class="at">interpolate =</span> <span class="st">&quot;monthly&quot;</span>, <span class="at">interpolate_method =</span> <span class="st">&quot;eop&quot;</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_filter</span>(stsm, <span class="at">y =</span> ts.eop[, <span class="fu">c</span>(<span class="st">&quot;qtr&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;observed&quot;</span>, <span class="st">&quot;interpolated&quot;</span>)], </span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>                ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)], <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>, <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>eop.err <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">method =</span> <span class="st">&quot;eop&quot;</span>, stsm_fc[<span class="fu">is.na</span>(observed), .(<span class="at">mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y <span class="sc">-</span> interpolated)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))])</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">melt</span>(stsm_fc, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">&quot;y&quot;</span>, <span class="st">&quot;interpolated&quot;</span>))[<span class="sc">!</span><span class="fu">is.na</span>(value), ]) <span class="sc">+</span> </span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> </span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a><span class="co">#Period average</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>ts.avg <span class="ot">=</span> ts[, .(<span class="at">y =</span> <span class="fu">mean</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), by <span class="ot">=</span> <span class="st">&quot;qtr&quot;</span>]</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(<span class="at">y =</span> ts.avg[, <span class="fu">c</span>(<span class="st">&quot;qtr&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">seasons =</span> <span class="dv">4</span>, <span class="at">multiplicative =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>                     <span class="at">interpolate =</span> <span class="st">&quot;monthly&quot;</span>, <span class="at">interpolate_method =</span> <span class="st">&quot;avg&quot;</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_filter</span>(stsm, <span class="at">y =</span> ts.avg[, <span class="fu">c</span>(<span class="st">&quot;qtr&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;observed&quot;</span>, <span class="st">&quot;interpolated&quot;</span>)], </span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>                ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;y_avg&quot;</span>)], <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>, <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(stsm<span class="sc">$</span>multiplicative <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">exp</span>(<span class="fu">frollmean</span>(<span class="fu">log</span>(interpolated), <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>))]</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollmean</span>(interpolated, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>avg.err <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">method =</span> <span class="st">&quot;avg&quot;</span>, </span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>                stsm_fc[, .(<span class="at">mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y <span class="sc">-</span> interpolated)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))], </span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>                stsm_fc[<span class="fu">is.na</span>(observed), .(<span class="at">mape_rollup =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y_avg <span class="sc">-</span> interpolated_rollup)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y_avg)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))])</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">melt</span>(stsm_fc, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">&quot;y&quot;</span>, <span class="st">&quot;interpolated&quot;</span>))[<span class="sc">!</span><span class="fu">is.na</span>(value), ]) <span class="sc">+</span> </span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> </span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a><span class="co">#Period sum</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>ts.sum <span class="ot">=</span> ts[, .(<span class="at">y =</span> <span class="fu">sum</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), by <span class="ot">=</span> <span class="st">&quot;qtr&quot;</span>]</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(<span class="at">y =</span> ts.sum[, <span class="fu">c</span>(<span class="st">&quot;qtr&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">seasons =</span> <span class="dv">4</span>, <span class="at">multiplicative =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>                     <span class="at">interpolate =</span> <span class="st">&quot;monthly&quot;</span>, <span class="at">interpolate_method =</span> <span class="st">&quot;sum&quot;</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_filter</span>(stsm, <span class="at">y =</span> ts.sum[, <span class="fu">c</span>(<span class="st">&quot;qtr&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">with =</span> <span class="cn">FALSE</span>], <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;observed&quot;</span>, <span class="st">&quot;interpolated&quot;</span>)], </span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>                ts[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;y_sum&quot;</span>)], <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>, <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(stsm<span class="sc">$</span>multiplicative <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">exp</span>(<span class="fu">frollsum</span>(<span class="fu">log</span>(interpolated), <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>))]</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollsum</span>(interpolated, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>sum.err <span class="ot">=</span> <span class="fu">cbind</span>(<span class="at">method =</span> <span class="st">&quot;sum&quot;</span>, </span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>                stsm_fc[, .(<span class="at">mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y <span class="sc">-</span> interpolated)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))], </span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>                stsm_fc[<span class="fu">is.na</span>(observed), .(<span class="at">mape_rollup =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y_sum <span class="sc">-</span> interpolated_rollup)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y_sum)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))])</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">melt</span>(stsm_fc, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">&quot;y&quot;</span>, <span class="st">&quot;interpolated&quot;</span>))[<span class="sc">!</span><span class="fu">is.na</span>(value), ]) <span class="sc">+</span> </span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> </span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a><span class="co">#Errors depend on the volatility of the series</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a><span class="co">#the end of period method is more susceptible to the volatility of the series than either</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a><span class="co">#the average or sum methods</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(eop.err, avg.err, sum.err, <span class="at">use.names =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="real-data-interpolation" class="section level2">
<h2>Real Data Interpolation</h2>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(autostsm)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="do">##### Unemployment rate examples #####</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#Not seasonally adjusted</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;UNRATENSA&quot;</span>, <span class="at">package =</span> <span class="st">&quot;autostsm&quot;</span>) <span class="co">#From FRED</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>UNRATENSA <span class="ot">=</span> <span class="fu">data.table</span>(UNRATENSA, <span class="at">keep.rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(UNRATENSA) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>UNRATENSA[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>UNRATENSA[, <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(y)]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>UNRATENSA[, <span class="st">&quot;qtr&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">ceiling_date</span>(date, <span class="st">&quot;quarter&quot;</span>) <span class="sc">%m-%</span> <span class="fu">months</span>(<span class="dv">1</span>)]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>UNRATENSA[, <span class="st">&quot;y_avg&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollmean</span>(y, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Cycle taken from previous example</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(<span class="at">y =</span> UNRATENSA[, .(<span class="at">y =</span> <span class="fu">mean</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">by =</span> <span class="st">&quot;qtr&quot;</span>], </span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                     <span class="at">seasons =</span> <span class="dv">4</span>, <span class="at">cycle =</span> <span class="dv">156</span><span class="sc">/</span><span class="dv">3</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                     <span class="at">interpolate =</span> <span class="st">&quot;monthly&quot;</span>, <span class="at">interpolate_method =</span> <span class="st">&quot;avg&quot;</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_filter</span>(stsm, <span class="at">y =</span> UNRATENSA[, .(<span class="at">y =</span> <span class="fu">mean</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">by =</span> <span class="st">&quot;qtr&quot;</span>], <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;observed&quot;</span>, <span class="st">&quot;interpolated&quot;</span>)], </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>                UNRATENSA[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;y_avg&quot;</span>)], <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>, <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(stsm<span class="sc">$</span>multiplicative <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">exp</span>(<span class="fu">frollmean</span>(<span class="fu">log</span>(interpolated), <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>))]</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollmean</span>(interpolated, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(stsm_fc[, .(<span class="at">mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y <span class="sc">-</span> interpolated)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))], </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>      stsm_fc[<span class="fu">is.na</span>(observed), .(<span class="at">mape_rollup =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y_avg <span class="sc">-</span> interpolated_rollup)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y_avg)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))])</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">melt</span>(stsm_fc, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">&quot;y&quot;</span>, <span class="st">&quot;interpolated&quot;</span>))[<span class="sc">!</span><span class="fu">is.na</span>(value), ]) <span class="sc">+</span> </span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a><span class="co">#Seasonally adjusted</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;UNRATE&quot;</span>, <span class="at">package =</span> <span class="st">&quot;autostsm&quot;</span>) <span class="co">#From FRED</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>UNRATE <span class="ot">=</span> <span class="fu">data.table</span>(UNRATE, <span class="at">keep.rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(UNRATE) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>UNRATE[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>UNRATE[, <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(y)]</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>UNRATE[, <span class="st">&quot;qtr&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">ceiling_date</span>(date, <span class="st">&quot;quarter&quot;</span>) <span class="sc">%m-%</span> <span class="fu">months</span>(<span class="dv">1</span>)]</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>UNRATE[, <span class="st">&quot;y_avg&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollmean</span>(y, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="co">#Cycle taken from previous example</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(<span class="at">y =</span> UNRATE[, .(<span class="at">y =</span> <span class="fu">mean</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">by =</span> <span class="st">&quot;qtr&quot;</span>], </span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>                     <span class="at">seasons =</span> <span class="cn">FALSE</span>, <span class="at">cycle =</span> <span class="dv">156</span><span class="sc">/</span><span class="dv">3</span>,</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>                     <span class="at">interpolate =</span> <span class="st">&quot;monthly&quot;</span>, <span class="at">interpolate_method =</span> <span class="st">&quot;avg&quot;</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_filter</span>(stsm, <span class="at">y =</span> UNRATE[, .(<span class="at">y =</span> <span class="fu">mean</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">by =</span> <span class="st">&quot;qtr&quot;</span>], <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;observed&quot;</span>, <span class="st">&quot;interpolated&quot;</span>)], </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>                UNRATE[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;y_avg&quot;</span>)], <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>, <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(stsm<span class="sc">$</span>multiplicative <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">exp</span>(<span class="fu">frollmean</span>(<span class="fu">log</span>(interpolated), <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>))]</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollmean</span>(interpolated, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(stsm_fc[, .(<span class="at">mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y <span class="sc">-</span> interpolated)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))], </span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>      stsm_fc[<span class="fu">is.na</span>(observed), .(<span class="at">mape_rollup =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y_avg <span class="sc">-</span> interpolated_rollup)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y_avg)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))])</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">melt</span>(stsm_fc, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">&quot;y&quot;</span>, <span class="st">&quot;interpolated&quot;</span>))[<span class="sc">!</span><span class="fu">is.na</span>(value), ]) <span class="sc">+</span> </span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> </span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span></span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a><span class="co">#5 Year Treasury Yield</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;DGS5&quot;</span>, <span class="at">package =</span> <span class="st">&quot;autostsm&quot;</span>) <span class="co">#From FRED</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>DGS5 <span class="ot">=</span> <span class="fu">data.table</span>(DGS5, <span class="at">keep.rownames =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(DGS5) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>)</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>DGS5[, <span class="st">&quot;date&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>DGS5[, <span class="st">&quot;y&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">as.numeric</span>(y)]</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>DGS5[, <span class="st">&quot;qtr&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">ceiling_date</span>(date, <span class="st">&quot;quarter&quot;</span>) <span class="sc">%m-%</span> <span class="fu">months</span>(<span class="dv">1</span>)]</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>DGS5[, <span class="st">&quot;y_avg&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollmean</span>(y, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="co">#Cycle taken from previous example</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>stsm <span class="ot">=</span> <span class="fu">stsm_estimate</span>(<span class="at">y =</span> DGS5[, .(<span class="at">y =</span> <span class="fu">mean</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">by =</span> <span class="st">&quot;qtr&quot;</span>], </span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>                     <span class="at">seasons =</span> <span class="cn">FALSE</span>, <span class="at">cycle =</span> <span class="dv">112</span><span class="sc">/</span><span class="dv">3</span>,</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>                     <span class="at">interpolate =</span> <span class="st">&quot;monthly&quot;</span>, <span class="at">interpolate_method =</span> <span class="st">&quot;avg&quot;</span>, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">stsm_filter</span>(stsm, <span class="at">y =</span> DGS5[, .(<span class="at">y =</span> <span class="fu">mean</span>(y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)), <span class="at">by =</span> <span class="st">&quot;qtr&quot;</span>], <span class="at">plot =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>stsm_fc <span class="ot">=</span> <span class="fu">merge</span>(stsm_fc[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;observed&quot;</span>, <span class="st">&quot;interpolated&quot;</span>)], </span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>                DGS5[, <span class="fu">c</span>(<span class="st">&quot;date&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;y_avg&quot;</span>)], <span class="at">by =</span> <span class="st">&quot;date&quot;</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>, <span class="at">all.y =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(stsm<span class="sc">$</span>multiplicative <span class="sc">==</span> <span class="cn">TRUE</span>){</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">exp</span>(<span class="fu">frollmean</span>(<span class="fu">log</span>(interpolated), <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>))]</span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>}<span class="cf">else</span>{</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>  stsm_fc[, <span class="st">&quot;interpolated_rollup&quot;</span> <span class="sc">:</span><span class="er">=</span> <span class="fu">frollmean</span>(interpolated, <span class="at">n =</span> <span class="dv">3</span>, <span class="at">align =</span> <span class="st">&quot;right&quot;</span>)]</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a><span class="fu">cbind</span>(stsm_fc[, .(<span class="at">mape =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y <span class="sc">-</span> interpolated)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))], </span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>      stsm_fc[<span class="fu">is.na</span>(observed), .(<span class="at">mape_rollup =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(y_avg <span class="sc">-</span> interpolated_rollup)<span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> y_avg)<span class="sc">*</span><span class="dv">100</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))])</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">melt</span>(stsm_fc, <span class="at">id.vars =</span> <span class="st">&quot;date&quot;</span>, <span class="at">measure.vars =</span> <span class="fu">c</span>(<span class="st">&quot;y&quot;</span>, <span class="st">&quot;interpolated&quot;</span>))[<span class="sc">!</span><span class="fu">is.na</span>(value), ]) <span class="sc">+</span> </span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">group =</span> variable, <span class="at">color =</span> variable)) <span class="sc">+</span> </span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis_d</span>() <span class="sc">+</span> </span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color =</span> <span class="fu">guide_legend</span>(<span class="at">title =</span> <span class="cn">NULL</span>)) <span class="sc">+</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
